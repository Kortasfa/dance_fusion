<div>
    <link rel="stylesheet" href="/static/css/gameField.css"/>
    <script src="/static/script/gameField.js" defer></script>
    <div class="rank">
        <div class="rank__hero" id="hero1">
            <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
            <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
            <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
            <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
            <div class="user__head">
                <div class="head__body"><img class="body" id="bodyImg1" alt=""></div>
                <div class="head__face"><img class="face" id="faceImg1" alt=""></div>
                <div class="head__hat"><img class="hat" id="hatImg1" alt=""></div>
            </div>
            <span class="hero__name">Name 1</span>
            <div class="hidden hero-score">0</div>
            <div class="hero__score">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star score__star_mega hidden" src="/static/img/mega_star.svg">
            </div>
        </div>
        <div class="rank__hero hidden" id="hero2">
            <div class="user__head">
                <div class="head__body"><img class="body" id="bodyImg2" alt=""></div>
                <div class="head__face"><img class="face" id="faceImg2" alt=""></div>
                <div class="head__hat"><img class="hat" id="hatImg2" alt=""></div>
            </div>
            <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
            <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
            <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
            <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
            <span class="hero__name">Name 2</span>
            <div class="hidden hero-score">0</div>
            <div class="hero__score">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star score__star_mega  hidden" src="/static/img/mega_star.svg">
            </div>
        </div>
        <div class="rank__hero hidden" id="hero3">
            <div class="user__head">
                <div class="head__body"><img class="body" id="bodyImg3" alt=""></div>
                <div class="head__face"><img class="face" id="faceImg3" alt=""></div>
                <div class="head__hat"><img class="hat" id="hatImg3" alt=""></div>
            </div>
            <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
            <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
            <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
            <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
            <span class="hero__name">Name 3</span>
            <div class="hidden hero-score">0</div>
            <div class="hero__score">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star score__star_mega  hidden" src="/static/img/mega_star.svg">
            </div>
        </div>
        <div class="rank__hero hidden" id="hero4">
            <div class="user__head">
                <div class="head__body"><img class="body" id="bodyImg4" alt=""></div>
                <div class="head__face"><img class="face" id="faceImg4" alt=""></div>
                <div class="head__hat"><img class="hat" id="hatImg4" alt=""></div>
            </div>
            <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
            <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
            <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
            <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
            <span class="hero__name">Name 4</span>
            <div class="hidden hero-score">0</div>
            <div class="hero__score">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star" src="/static/img/star_white.svg">
                <img class="score__star score__star_mega  hidden" src="/static/img/mega_star.svg">
            </div>
        </div>
    </div>
    <div class="dance-block__ratingScale"></div>
    <a class="btn-exit" href="/room">
        <img src="/static/img/log_out.svg" alt="">
    </a>
    <video id="video-dance" class="video-dance" type="video/mp4" width="100%" autoplay="autoplay">
        <source id="video-src" src="../video/previews/americanGirl.mp4">
    </video>
    <div class="pop-up hidden" id="pop-up">
        <div class="rating">
            <div class="rating__title">
                <div class="title__item">Total Score</div>
            </div>
            <div class="rating__list">
                <div class="best-player">
                    <img class="best-player__crown" src="../static/img/crown.png" alt="">
                    <div class="best-player__score"></div>
                </div>
                <div class="list">
                    <ol class="list__players">
                        <li id="player-result1" class="player hidden">
                            <div class="player__place">1</div>
                            <span id="user-score1" class="player-score">User 1: 0</span>
                        </li>
                        <li id="player-result2" class="player hidden">
                            <div class="player__place">2</div>
                            <span id="user-score2" class="player-score">User 2: 0</span>
                        </li>
                        <li  id="player-result3" class="player hidden">
                            <div class="player__place">3</div>
                            <span id="user-score3" class="player-score">User 3: 0</span>
                        </li>
                        <li id="player-result4" class="player hidden">
                            <div class="player__place">4</div>
                            <span id="user-score4" class="player-score">User 4: 0</span>
                        </li>
                    </ol>
                </div>
            </div>
            <button id="btn-continue" class="pop-up-box__start-btn" type="button">Continue</button>
        </div>
    </div>
    <script>
        function removeUser(userID) {
            console.log('Пользователь вышел: ' + userID);
            const usersBlock = document.querySelector(".rank");
            let index = 0;
            for (const userBlock of usersBlock.children) {
                index += 1;
                if (userBlock.id === userID.toString()) {
                    userBlock.id = "0";
                    let userScore = document.getElementById('user-score' + index);
                    userScore.classList.add('hidden');
                    userBlock.classList.add('hidden');
                    break
                }
            }
        }

        async function sendPoint(userID, point) {
            const response = await fetch("/api/sendPoint", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    "UserID": userID,
                    "point": point,
                }),
            });
            if (response.ok) {
                console.log('Балл отправлен');
            } else {
                console.log('Не удалось отправить балл');
            }
        }

        function getBestPlayer(songID) {
            fetch("../api/getBestPlayer", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `song_id=${songID}`,
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server Error');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.UserInfo) {
                        console.log('Best Player Info:');
                        console.log('User ID:', data.UserInfo.UserID);
                        console.log('User Name:', data.UserInfo.UserName);
                        console.log('Best Score:', data.BestScore);
                        let bestUserScore = document.querySelector('.best-player__score');
                        bestUserScore.innerText = data.UserInfo.UserName + ': ' + data.BestScore;
                        let score = document.querySelectorAll('.hero-score');
                        let info = document.querySelectorAll('.player-score');
                        let users = document.querySelectorAll('.rank__hero');
                        let bestPlayerScore = score[0].innerText;
                        let bestPlayerId = users[0].id;
                        let I = 0;
                        for (let i = 0; i < 4; i++){
                            info[i].innerText = info[i].innerText + ' ' + score[i].innerText;
                            if (score[i].innerText > bestPlayerScore){
                                bestPlayerId = users[i].id;
                                bestPlayerScore = score[i].innerText;
                                I = i;
                            }
                        }
                        if ((bestPlayerScore > data.BestScore) && (bestPlayerId > 0)){
                            bestUserScore.innerText = info[I].innerText;
                            updateBestUserInfo(parseInt(songId), parseInt(bestPlayerId), parseInt(bestPlayerScore));
                        }
                    } else {
                        console.log('Best Player Info not available for this song.');
                    }
                })
                .catch(error => {
                    console.log('Error:', error);
                });
        }
        function updateBestUserInfo(songID, userID, score) {
            const data = {
                song_id: songID,
                user_id: userID,
                score: score
            };

            fetch('../api/updateBestPlayer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => {
                    if (response.ok) {
                        console.log('Best User Info updated successfully.');
                    } else {
                        console.error('Error updating Best User Info', response.statusText);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        (async () => {
            let classifier = new EdgeImpulseClassifier();
            await classifier.init();
            let project = classifier.getProjectInfo();
            console.log(project.owner + ' / ' + project.name + ' (version ' + project.deploy_version + ')');

            let socket = new WebSocket("wss://" + window.location.hostname + "/neuralWS/" + WssURL.split("/").pop().trim());

            socket.onopen = function (event) {
                console.log("WebSocket connection established.");
            };

            let maxPoint;

            socket.onmessage = function (event) {
                try {
                    let jsonData = JSON.parse(event.data);
                    console.log(jsonData);
                    if ("ExitingUser" in jsonData) {
                        console.log("Удаляем пользователя на чёрт");
                        removeUser(jsonData.ExitingUser);
                        return;
                    }
                    if ("maxPoint" in jsonData) {
                        maxPoint = jsonData["maxPoint"];
                        console.log("MaxPoint = ", jsonData["maxPoint"]);
                        return;
                    }
                    let moveName = jsonData.name;
                    let motionString = jsonData.motionString;
                    let userID = jsonData.userID;
                    let features = motionString.split(',').map(x => Number(x.trim()));

                    let deviationCount = 0;
                    let startValues = [0, 0, 0];
                    let indexInOneRecord = 0;
                    for (let value of features) {
                        if (value !== 0 && (indexInOneRecord > 2)) {
                            if (startValues[5 - indexInOneRecord] === 0) {
                                startValues[5 - indexInOneRecord] = value;
                            } else if (Math.abs(Math.abs(value) - Math.abs(startValues[5 - indexInOneRecord])) > 20) {
                                deviationCount += 1;
                            }
                            if (deviationCount > 5) {
                                break;
                            }
                        }
                        indexInOneRecord += 1;
                        if (indexInOneRecord === 6) {
                            indexInOneRecord = 0;
                        }
                    }

                    if (deviationCount > 5) {
                        let res = classifier.classify(features); // результат оценки нейросетью JSON
                        let score = -1;
                        console.log(res["results"]);
                        for (let motionDict of res["results"]) {
                            if (motionDict["label"] === moveName) {
                                score = motionDict["value"];
                                if (moveName === "up-down-click") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    let sameMoveTwo = res["results"].find(item => item.label === "up-down-hands");
                                    score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.2;
                                    }
                                }
                                if (moveName === "up-down-hands") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.001 && score < 0.1) {
                                        score = 0.2;
                                    }
                                }
                                if (moveName === "collapsing-breeding-locks") {
                                    if (score > 0.001 && score < 0.005) {
                                        score = 0.2
                                    }
                                    if (score >= 0.005 && score < 0.01) {
                                        score = 0.3;
                                    }
                                    if (score >= 0.01) {
                                        score = 0.4;
                                    }

                                }
                                if (moveName === "going-to-the-side-with-clapping") {
                                    if (score > 0.001 && score < 0.05) {
                                        score = 0.2;
                                    }
                                    if (score >= 0.05 & score < 0.1) {
                                        score = 0.3;
                                    }
                                    if (score >= 0.1) {
                                        score = 0.4;
                                    }

                                }
                                if (moveName === "hands-up-and-down") {
                                    let sameMoveOne = res["results"].find(item => item.label === "up-down-click");
                                    let sameMoveTwo = res["results"].find(item => item.label === "up-down-hands");
                                    score = Math.max(motionDict["value"], sameMoveOne.value - 0.1, sameMoveTwo.value - 0.1);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.2;
                                    }
                                }
                                if (moveName === "hands-up-down-sideways") {
                                    if (score > 0.001 && score < 0.05) {
                                        score = 0.2;
                                    }
                                    if (score >= 0.05 && score < 0.1) {
                                        score = 0.3;
                                    }
                                    if (score >= 0.1) {
                                        score = 0.4;
                                    }

                                }
                                if (moveName === "side-hit") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.01 && score < 0.05) {
                                        score = 0.2;
                                    }
                                    if (score >= 0.05 & score < 0.1) {
                                        score = 0.3;
                                    }
                                    if (score >= 0.1) {
                                        score = 0.4;

                                    }
                                }
                                if (moveName === "down-from-the-middle-in-arc") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "collapsing-breeding-locks") {
                                    let sameMoveOne = res["results"].find(item => item.label === "up-down-hands");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "draw-circle") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    let sameMoveTwo = res["results"].find(item => item.label === "up-down-hands");
                                    score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "i-am-strong") {
                                    let sameMoveOne = res["results"].find(item => item.label === "gold-turn");
                                    let sameMoveTwo = res["results"].find(item => item.label === "gold-circle");
                                    let sameMoveThree = res["results"].find(item => item.label === "hands-up-and-down");
                                    score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value, sameMoveThree.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "broad-back") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "like-a-chicken") {
                                    let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "gold-circle") {
                                    let sameMoveOne = res["results"].find(item => item.label === "up-down-click");
                                    score = Math.max(motionDict["value"], sameMoveOne.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                                if (moveName === "gold-turn") {
                                    let sameMoveOne = res["results"].find(item => item.label === "down-from-the-middle-in-arc");
                                    let sameMoveTwo = res["results"].find(item => item.label === "gold-circle");
                                    score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                                    if (score > 0.01 && score < 0.1) {
                                        score = 0.1;
                                    }
                                }
                            }
                        }
                        console.log(moveName);
                        console.log(score);
                        let point = 0;
                        if (score >= 0.4 && score <= 1) {
                            point = 40;
                        }
                        if (score >= 0.3 && score < 0.4) {
                            point = Math.round(score * 400 / 4);

                        }
                        if (score >= 0.2 && score < 0.3) {
                            point = Math.round(score * 100) + 5;

                        }
                        if (score > 0.1 && score < 0.2) {
                            point = Math.round(score * 100) + 7;
                        }
                        if (score <= 0.1 && score > 0) {
                            point = Math.round(score * 100) + 9;
                        }
                        if (score === 2) {
                            point = 200;
                        }
                        console.log('Кол-во баллов', point);
                        addScore(userID.toString(), point, maxPoint);
                        sendPoint(userID, point).then(() => {
                        })
                    } else {
                        console.log('Лежит', deviationCount);
                        addScore(userID.toString(), 0);
                    }
                } catch (ex) {
                    console.log(ex);
                }
            };

            socket.onclose = function (event) {
                console.log("WebSocket connection closed.");
            };
        })();
    </script>
</div>
