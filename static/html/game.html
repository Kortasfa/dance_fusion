<html lang="en">
<head>
	  <title>Dance Fusion</title>
  	<link rel="stylesheet" href="/static/css/gameField.css"/>
  <script src="/static/script/gameField.js" defer></script>
</head>
<body class="main">
  <div class="rank">
    <div class="rank__hero" id="hero1">
      <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
      <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
      <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
      <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
      <img class="hero__avatar" id="heroImg1" src=""  alt="">
      <span class="hero__name" id="heroName1">Name 1</span>
      <span class="hero__score">0</span>
    </div>
    <div class="rank__hero hidden" id="hero2">
      <img class="hero__avatar" id="heroImg2" src=""  alt="">
      <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
      <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
      <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
      <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
      <span class="hero__name" id="heroName2">Name 2</span>
      <span class="hero__score">0</span>
    </div>
    <div class="rank__hero hidden" id="hero3">
      <img class="hero__avatar" id="heroImg3" src=""  alt="">
      <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
      <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
      <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
      <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
      <span class="hero__name" id="heroName3">Name 3</span>
      <span class="hero__score">0</span>
    </div>
    <div class="rank__hero hidden" id="hero4">
      <img class="hero__avatar" id="heroImg4" src=""  alt="">
      <img class="hero__rating-good hidden" src="/static/img/good.gif" alt="">
      <img class="hero__rating-perfect hidden" src="/static/img/perfect.gif" alt="">
      <img class="hero__rating-ok hidden" src="/static/img/OK.gif" alt="">
      <img class="hero__rating-x hidden" src="/static/img/X.png" alt="">
      <span class="hero__name" id="heroName4">Name 4</span>
      <span class="hero__score">0</span>
    </div>
  </div>
  <a class="btn-exit" href="/room">
    <img src="/static/img/log_out.svg" alt="">
  </a>
  <video id="video-dance" class="video-dance" type="video/mp4" width="100%" autoplay="autoplay">
    <source id="video-src" src="../video/americanGirl.mp4">
  </video>
  <div class="pop-up hidden" id="pop-up">
    <div class="pop-up__pop-up-box">
      <span class="pop-up-box__question">Total score</span>
      <span id="user-score1" class="pop-up-box__user-score hidden">User 1: 0</span>
      <span id="user-score2" class="pop-up-box__user-score hidden">User 2: 0</span>
      <span id="user-score3" class="pop-up-box__user-score hidden">User 3: 0</span>
      <span id="user-score4" class="pop-up-box__user-score hidden">User 4: 0</span>
      <button id="btn-continue" class="pop-up-box__start-btn" type="button">Continue</button>
    </div>
  </div>
  <script>
    (async () => {
        let classifier = new EdgeImpulseClassifier();
        await classifier.init();
        let project = classifier.getProjectInfo();
        console.log(project.owner + ' / ' + project.name + ' (version ' + project.deploy_version + ')');

        let socket = new WebSocket("wss://" + window.location.hostname + "/neuralWS/" + WssURL.split("/").pop().trim());

        socket.onopen = function (event) {
            console.log("WebSocket connection established.");
        };

        socket.onmessage = function (event) {
            try {
                let jsonData = JSON.parse(event.data);
                //console.log(jsonData);
                let moveName = jsonData.name;
                //let userID = mesData["userID"];
                let motionString = jsonData.motionString;
                let userID = jsonData.userID;
                //console.log(motionString);
                let features = motionString.split(',').map(x => Number(x.trim()));
                let res = classifier.classify(features); // результат оценки нейросетью JSON
                console.log(res["results"]);
                let score = -1;
                for (let motionDict of res["results"]) {
                    if (motionDict["label"] === moveName) {
                        score = motionDict["value"];
                        if (moveName === "up-down-click") {
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            let sameMoveTwo = res["results"].find(item => item.label === "up-down-hands");
                            score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "up-down-hands") {
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.2;
                            }
                        }
                        if (moveName === "collapsing-breeding-locks"){
                            if (score > 0.001 && score < 0.005) {
                                score = 0.2
                            }
                            if (score >= 0.005 && score < 0.01) {
                                score = 0.3;
                            }
                            if (score >= 0.01) {
                                score = 0.4;
                            }

                        }
                        if (moveName === "going-to-the-side-with-clapping"){
                            if (score > 0.001 && score < 0.05) {
                                score = 0.2;
                            }
                            if (score >= 0.05 & score < 0.1) {
                                score = 0.3;
                            }
                            if (score >= 0.1) {
                                score = 0.4;
                            }

                        }
                        if (moveName === "hands-up-and-down") {
                            let sameMoveOne = res["results"].find(item => item.label === "up-down-click");
                            let sameMoveTwo = res["results"].find(item => item.label === "up-down-hands");
                            score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "hands-up-down-sideways") {
                            if (score > 0.001 && score < 0.05) {
                                score = 0.2;
                            }
                            if (score >= 0.05 && score < 0.1) {
                                score = 0.3;
                            }
                            if (score >= 0.1) {
                                score = 0.4;
                            }

                        }
                        if (moveName === "side-hit") {
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.05) {
                                score = 0.2;
                            }
                            if (score >= 0.05 & score < 0.1) {
                                score = 0.3;
                            }
                            if (score >= 0.1) {
                                score = 0.4;

                            }
                        }
                        if (moveName === "down-from-the-middle-in-arc") {
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "collapsing-breeding-locks") {
                            let sameMoveOne = res["results"].find(item => item.label === "up-down-hands");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "draw-circle") {
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            let sameMoveTwo = res["results"].find(item => item.label === "up-down-hands");
                            score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "i-am-strong"){
                            let sameMoveOne = res["results"].find(item => item.label === "gold-turn");
                            let sameMoveTwo = res["results"].find(item => item.label === "gold-circle");
                            score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "broad-back"){
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "like-a-chicken"){
                            let sameMoveOne = res["results"].find(item => item.label === "hands-up-and-down");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "gold-circle"){
                            let sameMoveOne = res["results"].find(item => item.label === "up-down-click");
                            score = Math.max(motionDict["value"], sameMoveOne.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                        if (moveName === "gold-turn"){
                            let sameMoveOne = res["results"].find(item => item.label === "down-from-the-middle-in-arc");
                            let sameMoveTwo = res["results"].find(item => item.label === "gold-circle");
                            score = Math.max(motionDict["value"], sameMoveOne.value, sameMoveTwo.value);
                            if (score > 0.01 && score < 0.1) {
                                score = 0.1;
                            }
                        }
                    }
                }
                console.log(moveName);
                console.log(score);
                if (score >= 0.4) {
                    AddScore(userID.toString(), 40);
                }
                if (score >= 0.3 && score < 0.4) {
                    AddScore(userID.toString(), Math.round(score * 400 / 4));
                }
                if (score >= 0.2 && score < 0.3) {
                    AddScore(userID.toString(), Math.round(score * 100) + 3);
                }
                if (score > 0.1 && score < 0.2) {
                    AddScore(userID.toString(), Math.round(score * 100) + 5);
                }
                if (score <= 0.1 && score > 0) {
                    AddScore(userID.toString(), Math.round(score * 100) + 7);
                }
            } catch (ex) {
                //alert('Failed to classify: ' + (ex.message || ex.toString()));
            }
        };

        socket.onclose = function (event) {
            console.log("WebSocket connection closed.");
        };
    })();
</script>
</body>
</html>
